---
globals:
  socketPath: /run/greggd.sock
  verboseFormat: influx
  verbose: true
  maxRetryCount: 1
  retryDelay: 100ms
  retryExponentialBackoff: true

# Hash of all programs to load
programs:
  - source: /usr/share/greggd/c/opensnoop.c
    # Events to bind program to
    events:
      - type: kprobe
        loadFunc: trace_entry
        attachTo: do_sys_open
      - type: kretprobe
        loadFunc: trace_return
        attachTo: do_sys_open
    # What should we read from
    outputs:
      - type: BPF_PERF_OUTPUT
        id: opensnoop
        format:
          - name: id
            type: u64
          - name: pid
            type: u32
            isTag: true
          - name: ret
            type: int32
          - name: fname
            type: char[255]
            isTag: true
            filter:
              "or":
                - "have-prefix": "\"/proc"
                - "have-prefix": "\"/sys"
          - name: flag
            type: int32
            formatString: "%#o"
  - source: /usr/share/greggd/c/tcplife.c
    # Events to bind program to
    events:
      - type: kprobe
        loadFunc: kprobe__tcp_set_state
        attachTo: tcp_set_state
    # ipv6 is left as an exercise to the reader
    # What should we read from
    outputs:
      - type: BPF_PERF_OUTPUT
        id: ipv4_events
        format:
          - name: pid
            type: u32
            isTag: true
          - name: laddr
            type: u32
            isIP: true
          - name: raddr
            type: u32
            isIP: true
  - source: /usr/share/greggd/c/tcplife.c
    # Events to bind program to
    events:
      - type: kprobe
        loadFunc: kprobe__tcp_set_state
        attachTo: tcp_set_state
    # ipv6 is left as an exercise to the reader
    # What should we read from
    outputs:
      - type: BPF_PERF_OUTPUT
        id: ipv4_events
        format:
          - name: pid
            type: u32
            isTag: true
          - name: laddr
            type: u32
            isIP: true
          - name: raddr
            type: u32
            isIP: true
  - source: /ccs/home/jvoss/greggd/csrc/ldist.c
    outputs:
      - type: BPF_HASH
        id: ldist_hist
        poll: 10s
        clear: true
        format:
          - name: slot
            type: u64
        key:
          name: keyy
          type: u32
          formatString: "%x"
